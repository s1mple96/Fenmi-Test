# ETC申办流程完整指南

## 流程概述

ETC申办流程是一个完整的15步自动化流程，从车牌校验到最终入库完成。

## 完整流程步骤

### 第一阶段：前置校验（步骤1-7）
1. **校验车牌** - 验证车牌号格式和有效性
2. **校验是否可申办** - 检查车牌是否已申办过ETC
3. **获取渠道地址** - 获取申办渠道信息
4. **获取可选服务** - 获取可选的ETC服务列表
5. **提交车牌** - 提交车牌信息，获取订单ID
6. **协议签署** - 签署ETC申办协议
7. **提交身份和银行卡信息** - 提交用户身份和银行卡信息，获取签约订单ID和验证码编号

### 第二阶段：验证码处理
- 弹出验证码输入对话框
- 用户输入验证码后，开始后续流程

### 第三阶段：核心申办流程（步骤8-11）
8. **签约校验** - 验证签约信息和验证码
9. **保存车辆信息** - 保存车辆详细信息
10. **可选服务更新** - 更新用户选择的可选服务
11. **代扣支付** - 执行代扣支付操作

### 第四阶段：数据库操作（步骤12-15）
12. **数据库状态修改** - 更新订单状态和用户状态
13. **一键入库流程** - 插入库存记录（OBU和ETC设备）
14. **卡用户OBU信息入库** - 更新用户OBU绑定信息
15. **流程完成** - 整个申办流程完成

## 日志规范

### 日志格式
- **开始**：`"{步骤号}. {步骤名称}"`
- **完成**：`"{步骤号}. {步骤名称}完成"`
- **失败**：`"{步骤号}. {步骤名称}失败: {错误信息}"`
- **异常**：`"{步骤号}. {步骤名称}异常: {异常详情}"`

### 日志显示
- 日志按倒序显示（最新日志在顶部）
- 接口异常会在日志中明确显示
- 每个步骤都有详细的进度提示

## 数据库操作

### 步骤12：状态更新
```sql
-- 更新订单状态
UPDATE rtx.rtx_etcapply_order SET order_status = '7' WHERE order_id = ?

-- 更新用户状态
UPDATE rtx.rtx_etc_card_user SET status = '1' WHERE car_num = ?
```

### 步骤13：库存入库
- 插入到 `hcb_newstock` 表
- 插入两条记录：OBU设备（TYPE=0）和ETC设备（TYPE=1）
- 使用界面传递的车牌号，不再随机生成

### 步骤14：用户OBU信息更新
```sql
UPDATE rtx.rtx_etc_card_user 
SET obu_no = ?, 
    etc_sn = ?, 
    activation_time = ?, 
    active_status = 3024, 
    status = '1' 
WHERE car_num = ?
```

## 错误处理

### 接口异常处理
- 每个步骤都有独立的异常处理
- 接口超时、连接失败等异常会在日志中明确显示
- 异常信息包含具体的错误原因和步骤标识

### 参数验证
- 关键参数（如车牌号）会在使用前进行验证
- 缺少必要参数会立即报错，避免后续操作失败

## 关键改进

### 车牌号处理
- 只使用界面传递的完整车牌号
- 不再随机生成车牌号
- 确保数据一致性

### OBU/ETC号生成
- step13生成OBU号和ETC号
- step14使用step13生成的值，确保一致性
- 避免重复生成导致的数据不一致

### 库存表操作
- 正确插入到 `hcb_newstock` 表（库存表）
- 而不是 `rtx_etc_card_user` 表（用户表）
- 符合业务逻辑

## 使用说明

1. 填写完整的申办信息
2. 点击"一键申办ETC"按钮
3. 输入验证码
4. 等待流程自动完成
5. 查看日志了解详细进度

## 注意事项

- 确保网络连接稳定，避免接口超时
- 车牌号必须完整填写
- 验证码必须在有效期内输入
- 流程执行过程中请勿关闭程序 